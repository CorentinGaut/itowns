<!DOCTYPE html>
<html>
    <head>
        <title>Itowns - WebXR Example</title>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" type="text/css" href="css/example.css">
    </head>
    <body>
        <div id="viewerDiv"></div>

        <script type="importmap">
            {
                "imports": {
                    "three": "../build/three.module.js",
                    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/"
                }
            }
        </script>

        <!-- Import iTowns source code -->
        <script src="../dist/itowns.js"></script>

        <script type="module">

            // import * as WebXR from 'three/addons/';
           import { XRButton } from 'three/addons/webxr/XRButton.js';
        //    import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';
        //    import { XRControllerModelFactory } from 'XRControllerModelFactory/XRControllerModelFactory.js';
	    itowns.proj4.defs("EPSG:2154","+proj=lcc +lat_0=46.5 +lon_0=3 +lat_1=49 +lat_2=44 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs");

            // ---------- SETUP THE VR VIEW : ----------

	    var altitude = 100;
	    var longitude = 2.5870426, latitude = 48.8409128; // mlv
//	    var longitude = 2.4223264, latitude = 48.8447549; // smd
//	    var longitude = 2.7922434, latitude = 50.4577818; // loos
//	    var longitude = 2.4676636, latitude = 48.8007534; // creteil
//	    var longitude = 3.855731 , latitude = 43.959178; // st hippo

            // Define camera initial position
            const placement = {         
                coord: new itowns.Coordinates('EPSG:4326', longitude, latitude),
                range: 200,
                tilt: 0,
                heading: 62,
            }

            // `viewerDiv` will contain iTowns' rendering area (`<canvas>`)
            const viewerDiv = document.getElementById('viewerDiv');

            // Create a GlobeView
            const view = new itowns.GlobeView(viewerDiv, placement, {
                webXR: { scale: 0.05 },
            });
	window.view = view;
            
            console.log(view);

            // Instantiate three's VR Button
            const xrButton = XRButton.createButton(view.renderer);
            viewerDiv.appendChild(xrButton);

            // ---------- DISPLAY ORTHO-IMAGES : ----------

            // Add one imagery layer to the scene. This layer's properties are
            // defined in a json file, but it could be defined as a plain js
            // object. See `Layer` documentation for more info.
            itowns.Fetcher.json('./layers/JSONLayers/Ortho.json').then((config) => {
                config.source = new itowns.WMTSSource(config.source);
                view.addLayer(new itowns.ColorLayer('Ortho', config),
                );
            });

            // ---------- DISPLAY A DIGITAL ELEVATION MODEL : ----------

            // Add two elevation layers, each with a different level of detail.
            // Here again, each layer's properties are defined in a json file.
            function addElevationLayerFromConfig(config) {
                config.source = new itowns.WMTSSource(config.source);
                view.addLayer(
                    new itowns.ElevationLayer(config.id, config),
                );
            }
            itowns.Fetcher.json('./layers/JSONLayers/IGN_MNT_HIGHRES.json')
                .then(addElevationLayerFromConfig);
            itowns.Fetcher.json('./layers/JSONLayers/WORLD_DTM.json')
                .then(addElevationLayerFromConfig);
                
                
                
            function colorBuildings(properties) {
                if (properties.usage_1 === 'RÃ©sidentiel') {
                    return color.set(0xFDFDFF);
                } else if (properties.usage_1 === 'Annexe') {
                    return color.set(0xC6C5B9);
                } else if (properties.usage_1 === 'Commercial et services') {
                    return color.set(0x62929E);
                } else if (properties.usage_1 === 'Religieux') {
                    return color.set(0x393D3F);
                } else if (properties.usage_1 === 'Sportif') {
                    return color.set(0x546A7B);
                }

                return color.set(0x555555);
            }

            function altitudeBuildings(properties) {
                return properties.altitude_minimale_sol;
            }

            function extrudeBuildings(properties) {
                return properties.hauteur;
            }

            function acceptFeature(properties) {
                return !!properties.hauteur;
            }

            var color = new itowns.THREE.Color();
            var meshes = [];
            var scaler = function update(/* dt */) {
                var i;
                var mesh;
                if (meshes.length) {
                    view.notifyChange(view.camera3D, true);
                }
                for (i = 0; i < meshes.length; i++) {
                    mesh = meshes[i];
                    if (mesh) {
                        mesh.scale.z = Math.min(
                            1.0, mesh.scale.z + 0.1);
                        mesh.updateMatrixWorld(true);
                    }
                }
                meshes = meshes.filter(function filter(m) { return m.scale.z < 1; });
            };

            view.addFrameRequester(itowns.MAIN_LOOP_EVENTS.BEFORE_RENDER, scaler);
           
            var wfsBuildingSource = new itowns.WFSSource({
                url: 'https://data.geopf.fr/wfs/ows?',
                version: '2.0.0',
                typeName: 'BDTOPO_V3:batiment',
                crs: 'EPSG:4326',
                ipr: 'IGN',
                format: 'application/json',/*
                extent: {
                    west: 3.5,
                    east: 4.1,
                    south: 43.7,
                    north: 44.3,
                },*/
            });


            var wfsBuildingLayer = new itowns.FeatureGeometryLayer('WFS Building',{
                batchId: function (property, featureId) { return featureId; },
                onMeshCreated: function scaleZ(mesh) {
                    mesh.children.forEach(c => {
                        c.scale.z = 0.01;
                        meshes.push(c);
                    })
                },
                filter: acceptFeature,
                source: wfsBuildingSource,
                zoom: { min: 14 },

                style: {
                    fill: {
                        color: colorBuildings,
                        base_altitude: altitudeBuildings,
                        extrusion_height: extrudeBuildings,
                    }
                }
            });
            view.addLayer(wfsBuildingLayer);

            // ---------- Set coontroller ----------


            // const controllerModelFactory = new XRControllerModelFactory();
    		// let controllerGrip = view.renderer.xr.getControllerGrip( 0 );
			// controllerGrip.add( controllerModelFactory.createControllerModel( controllerGrip ) );
			// view.scene.add( controllerGrip );

				
        </script>
    </body>
</html>
